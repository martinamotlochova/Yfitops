@using System.Runtime.CompilerServices
@using Yfitops.Shared
@inject HttpClient Http
@inject ISnackbar Snackbar

<MudDialog MaxWidth="MaxWidth.ExtraLarge" FullWidth="true">
    <DialogContent>
        @if (album != null)
        {
            <MudForm @ref="form">
                <MudTextField @bind-Value="album.Name"
                              Label="Name"
                              For="@(() => album.Name)" />

                <MudDatePicker @bind-Date="album.ReleaseDate"
                               Label="Release Date"
                               DateFormat="dd.MM.yyyy" />

                <MudCheckBox @bind-Value="album.IsFavourite"
                             Label="Add to Favorites?"
                             Color="Color.Primary" />


                <MudFileUpload T="IReadOnlyList<IBrowserFile>"
                               FilesChanged="UploadFiles"
                               Accept="image/*">
                    <ActivatorContent>
                        <MudFab Color="Color.Primary"
                                StartIcon="@Icons.Material.Filled.CloudUpload"
                                Label="Upload Cover Image" />
                    </ActivatorContent>
                </MudFileUpload>

                @if (selectedFile != null)
                {
                    <MudList T="string" Dense="true">
                        <MudListItem Icon="@Icons.Material.Filled.Image">
                            @selectedFile.Name <code>@(selectedFile.Size / 1024) KB</code>
                        </MudListItem>
                    </MudList>
                }

                @* Error message *@
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <MudAlert Severity="Severity.Error" Class="mt-2">
                        @errorMessage
                    </MudAlert>
                }
            </MudForm>
        }
    </DialogContent>

    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" OnClick="Save">Save</MudButton>
    </DialogActions>
</MudDialog>


@code {
    private MudForm form;

    private AlbumContract album;

    private IBrowserFile selectedFile;

    private string errorMessage = string.Empty;

    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter]
    public Guid? AlbumId { get; set; }

    [Parameter]
    public Guid ArtistId { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (AlbumId.HasValue)
        {
            album = await Http.GetFromJsonAsync<AlbumContract>($"api/album/{AlbumId}");

        }
        else
        {
            album = new AlbumContract();
            album.ArtistId = this.ArtistId;
        }
    }

    private void UploadFiles(IReadOnlyList<IBrowserFile> files)
    {
        errorMessage = string.Empty;

        if (files.Count == 0)
        {
            selectedFile = null;
            return;
        }

        var file = files[0];

        if (!file.ContentType.StartsWith("image/"))
        {
            errorMessage = "Invalid file type. Please upload an image file.";
            selectedFile = null;
            return;
        }

        var allowedExtensions = new[] { ".jpg", ".jpeg", ".png", ".gif", ".webp" };

        var fileExtension = Path.GetExtension(file.Name).ToLowerInvariant();

        if (!allowedExtensions.Contains(fileExtension))
        {
            errorMessage = $"Invalid file extension. Allowed: {string.Join(", ", allowedExtensions)}";
            selectedFile = null;
            return;
        }

        const long maxFileSize = 5 * 1024 * 1024;
        if (file.Size > maxFileSize)
        {
            errorMessage = "File size exceeds the maximum limit of 5 MB.";
            selectedFile = null;
            return;
        }

        selectedFile = file;
    }

    private async Task Save()
    {
        await form.Validate();
        if (!form.IsValid) return;

        if(selectedFile != null)
        {
            using var stream = new MemoryStream();
            await selectedFile.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024).CopyToAsync(stream);

            album.CoverImage = new StorageContract
            {
                FileName = selectedFile.Name,
                Size = selectedFile.Size,
                Data = stream.ToArray()
            };
        }

        HttpResponseMessage response;

        if (AlbumId.HasValue)
        {
            response = await Http.PutAsJsonAsync($"api/album/{album.Id}", album);
        }
        else
        {
            response = await Http.PostAsJsonAsync("api/album", album);
        }

        if (response.IsSuccessStatusCode)
        {
            Snackbar.Add("Operation was executed successfully!", Severity.Success);
            MudDialog.Close(DialogResult.Ok(album));
        }
        else
        {
            Snackbar.Add("Operation failed.", Severity.Error);
            MudDialog.Cancel();
        }
    }

    private void Cancel() => MudDialog.Cancel();
}