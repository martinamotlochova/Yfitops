@page "/tracks"
@using Yfitops.Shared
@using Yfitops.Client.Components.Dialogs
@inject HttpClient httpClient
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager

<MudToolBar>
    <MudText Typo="Typo.h6">Tracks</MudText>
    <MudSpacer />
    <MudIconButton Icon="@Icons.Material.Outlined.Add"
                   Color="Color.Primary"
                   OnClick="OpenAddDialogAsync"
                   Title="Add Track" />
</MudToolBar>

<MudPaper Class="p-4">
    @if (isLoading)
    {
        <div class="d-flex justify-center align-center" style="min-height: 200px;">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <MudAlert Severity="Severity.Error">@errorMessage</MudAlert>
    }
    else if (tracks == null || !tracks.Any())
    {
        <MudAlert Severity="Severity.Info">
            No tracks found in this album. Click the + button to add your first track!
        </MudAlert>
    }
    else
    {
        <MudGrid Spacing="3">
            @foreach (var track in tracks)
            {
                <MudItem xs="12" sm="6" md="4" lg="3">
                    <MudCard>
                        <MudCardContent>
                            <div class="d-flex justify-space-between align-center mb-2">
                                <MudText Typo="Typo.h6" Style="font-weight: 500;">
                                    @track.Name
                                </MudText>
                                @if (track.IsFavourite)
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.Star"
                                             Color="Color.Warning"
                                             Size="Size.Small"
                                             Title="Favourite" />
                                }
                            </div>

                            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3">
                                Duration: @FormatDuration(track.Duration)
                            </MudText>

                            @* Audio Player *@
                            @if (track.StorageId.HasValue)
                            {
                                <audio controls style="width: 100%; max-width: 100%;">
                                    <source src="@GetAudioUrl(track.Id)" type="audio/mpeg">
                                    Your browser does not support the audio element.
                                </audio>
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Warning" Dense="true">
                                    No audio file uploaded
                                </MudAlert>
                            }
                        </MudCardContent>

                        <MudCardActions>
                            <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                           Color="Color.Primary"
                                           Size="Size.Small"
                                           OnClick="@(() => OpenEditDialogAsync(track))"
                                           Title="Edit" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                           Color="Color.Error"
                                           Size="Size.Small"
                                           OnClick="@(() => DeleteTrack(track))"
                                           Title="Delete" />
                        </MudCardActions>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }
</MudPaper>

@code {
    [Parameter]
    public Guid AlbumId { get; set; }

    private List<TrackContract> tracks;
    private bool isLoading = true;
    private string errorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadTracks();
    }

    private async Task LoadTracks()
    {
        isLoading = true;
        errorMessage = string.Empty;

        try
        {
            tracks = await httpClient.GetFromJsonAsync<List<TrackContract>>($"api/track/list-by-album/{AlbumId}");

            if (tracks == null)
            {
                tracks = new List<TrackContract>();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load tracks: {ex.Message}";
            Snackbar.Add(errorMessage, Severity.Error);
            tracks = new List<TrackContract>();
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task OpenAddDialogAsync()
    {
        var parameters = new DialogParameters
        {
            { "AlbumId", this.AlbumId }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseButton = true
        };

        var dialog = await DialogService.ShowAsync<TrackDialog>("Add Track", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadTracks();
        }
    }

    private async Task OpenEditDialogAsync(TrackContract track)
    {
        var parameters = new DialogParameters
        {
            { "TrackId", track.Id },
            { "AlbumId", this.AlbumId }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseButton = true
        };

        var dialog = await DialogService.ShowAsync<TrackDialog>("Edit Track", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadTracks();
        }
    }

    private async Task DeleteTrack(TrackContract track)
    {
        bool? confirm = await DialogService.ShowMessageBox(
            "Confirm Delete",
            $"Are you sure you want to delete '{track.Name}'? This action cannot be undone.",
            yesText: "Delete",
            cancelText: "Cancel"
        );

        if (confirm != true)
            return;

        try
        {
            var response = await httpClient.DeleteAsync($"api/track/{track.Id}");

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Track deleted successfully!", Severity.Success);
                await LoadTracks();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Failed to delete track: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error deleting track: {ex.Message}", Severity.Error);
        }
    }

    private string GetAudioUrl(Guid trackId)
    {
        return $"{NavigationManager.BaseUri}api/track/{trackId}/stream";
    }

    private string FormatDuration(TimeSpan duration)
    {
        if (duration.Hours > 0)
            return $"{duration.Hours:D2}:{duration.Minutes:D2}:{duration.Seconds:D2}";
        else
            return $"{duration.Minutes:D2}:{duration.Seconds:D2}";
    }
}