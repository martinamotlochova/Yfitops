@page "/tracks/{AlbumId:guid}"

@using Yfitops.Shared
@using Yfitops.Client.Components.Dialogs

@inject HttpClient httpClient
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager

<MudToolBar>
    <MudText Typo="Typo.h6">Tracks</MudText>
    <MudIconButton @onclick="OpenAddDialogAsync" Icon="@Icons.Material.Outlined.Add" Class="ml-auto" />
</MudToolBar>

<MudPaper Class="p-4">
    @if (tracks == null)
    {
        <MudProgressCircular Color="Color.Primary" />
        <p>Loading tracks...</p>
    }
    else if (!tracks.Any())
    {
        <p>No tracks found</p>
    }
    else
    {
        <div class="d-flex flex-wrap" style="gap: 16px;">
            @foreach (var track in tracks)
            {
                <MudCard Style="width: 200px;">
                    <MudCardContent>
                        <MudText Typo="Typo.h6">@track.Name</MudText>
                        <MudTextField @bind-Value="track.Duration" Label="Duration" Placeholder="hh:mm:ss" Required="true" />
                        @if (track.IsFavourite)
                        {
                            <MudText Typo="Typo.subtitle2" Color="Color.Warning">⭐ Favourite</MudText>
                        }
                    </MudCardContent>
                    <MudCardActions>
                        <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small"
                            @onclick="() => OpenEditDialogAsync(track)">Edit</MudButton>
                        <MudButton Variant="Variant.Text" Color="Color.Error" Size="Size.Small" @onclick="() => Delete(track)">
                            Delete</MudButton>
                    </MudCardActions>
                </MudCard>
            }
        </div>
    }
</MudPaper>

@code {
    [Parameter]
    public Guid AlbumId { get; set; }

    private List<TrackContract> tracks;

    protected override async Task OnInitializedAsync()
    {
        tracks = await httpClient.GetFromJsonAsync<List<TrackContract>>($"api/track/list-by-album/{AlbumId}");
    }

    private async Task OpenAddDialogAsync()
    {
        var parameters = new DialogParameters();
        parameters.Add("AlbumId", this.AlbumId);

        var dialog = await DialogService.ShowAsync<TrackDialog>("Add Track", parameters);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            tracks = await httpClient.GetFromJsonAsync<List<TrackContract>>($"api/track/list-by-album/{AlbumId}");
        }
    }

    private async Task OpenEditDialogAsync(TrackContract track)
    {
        var parameters = new DialogParameters<TrackDialog>();
        parameters.Add("TrackId", track.Id);

        var dialog = await DialogService.ShowAsync<TrackDialog>("Edit Track", parameters);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            tracks = await httpClient.GetFromJsonAsync<List<TrackContract>>($"api/track/list-by-album/{AlbumId}");
        }
    }

    private async Task Delete(TrackContract track)
    {
        bool confirm = await DialogService.ShowMessageBox(
        "Confirm Delete",
        "Are you sure you want to delete this artist?",
        yesText: "Yes",
        cancelText: "No"
        ) ?? false;

        if (!confirm) return;

        var response = await httpClient.DeleteAsync($"api/track/{track.Id}");
        if (response.IsSuccessStatusCode)
        {
            Snackbar.Add("Track deleted successfully!", Severity.Success);
            tracks = await httpClient.GetFromJsonAsync<List<TrackContract>>($"api/track/list-by-album/{AlbumId}");
        }
        else
        {
            Snackbar.Add("Failed to delete track.", Severity.Error);
        }
    }
}