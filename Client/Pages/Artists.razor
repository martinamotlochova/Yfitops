@page "/artists"

@using Yfitops.Shared
@using Yfitops.Client.Components.Dialogs

@inject HttpClient httpClient
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager

<MudToolBar>
    <MudText Typo="Typo.h6">Artists</MudText>
    <MudIconButton @onclick="OpenAddDialogAsync" Icon="@Icons.Material.Outlined.Add" Class="ml-auto" />
</MudToolBar>

<MudPaper Class="p-4">
    @if (artists == null)
    {
        <MudProgressCircular Color="Color.Primary" />
        <p>Načítavam artistov...</p>
    }
    else if (!artists.Any())
    {
        <p>Žiadni artisti.</p>
    }
    else
    {
        <div class="d-flex flex-wrap" style="gap: 16px;">
            @foreach (var artist in artists)
            {
                <MudCard Style="width: 200px;">
                    <MudCardContent>
                        <MudText Typo="Typo.h6">@artist.Name</MudText>
                        @if (artist.IsFavourite)
                        {
                            <MudText Typo="Typo.subtitle2" Color="Color.Warning">⭐ Favourite</MudText>
                        }
                    </MudCardContent>
                    <MudCardActions>
                        <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small" @onclick="() => OpenEditDialogAsync(artist)">Edit</MudButton>
                        <MudButton Variant="Variant.Text" Color="Color.Error" Size="Size.Small" @onclick="() => Delete(artist)">Delete</MudButton>
                        <MudButton Variant="Variant.Text" Color="Color.Secondary" Size="Size.Small" @onclick="() => ViewAlbums(artist)">View</MudButton>
                    </MudCardActions>
                </MudCard>
            }
        </div>
    }
</MudPaper>

@code {
    private List<ArtistContract> artists;

    protected override async Task OnInitializedAsync()
    {
        artists = await httpClient.GetFromJsonAsync<List<ArtistContract>>("api/artist");
    }

    private async Task OpenAddDialogAsync()
    {
        var dialog = await DialogService.ShowAsync<ArtistDialog>("Add Artist");
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            artists = await httpClient.GetFromJsonAsync<List<ArtistContract>>("api/artist");
        }
    }

    private async Task OpenEditDialogAsync(ArtistContract artist)
    {
        var parameters = new DialogParameters<ArtistDialog>();
        parameters.Add("ArtistId", artist.Id);

        var dialog = await DialogService.ShowAsync<ArtistDialog>("Edit Artist", parameters);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            artists = await httpClient.GetFromJsonAsync<List<ArtistContract>>("api/artist");
        }
    }

    private async Task Delete(ArtistContract artist)
    {
        bool confirm = await DialogService.ShowMessageBox(
            "Confirm Delete",
            "Are you sure you want to delete this artist?",
            yesText: "Yes",
            cancelText: "No"
        ) ?? false;

        if (!confirm) return;

        var response = await httpClient.DeleteAsync($"api/artist/{artist.Id}");
        if (response.IsSuccessStatusCode)
        {
            Snackbar.Add("Artist deleted successfully!", Severity.Success);
            artists = await httpClient.GetFromJsonAsync<List<ArtistContract>>("api/artist");
        }
        else
        {
            Snackbar.Add("Failed to delete artist.", Severity.Error);
        }
    }

    private void ViewAlbums(ArtistContract artist)
    {
        NavigationManager.NavigateTo($"/albums/{artist.Id}");
    }
}
